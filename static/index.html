<!DOCTYPE html>

<html>
  <head>
    <title></title>
    
    <style type="text/css">
      html {background:#222; font-family:Helvetica, sans-serif;}
      
      h2 {color:#ccc; font-weight:normal; font-size:18px;}
      
      .endpoint {position:relative; height:100px;}
      .endpoint div {position:absolute; bottom:0; width:5px; margin:0 1px; background:#aaa; float:right;}
      .endpoint .alt {background:#fff;}
    </style>
  </head>
  
  <body>
    
    <h2>/Info</h2>
    <div id="running"></div>
    
    <script src="jquery.js" type="text/javascript"></script>
    <script type="text/javascript">
      var endpoints = {};
      
      function createEndpoint(parent, endpoint) {
        var parent = $(parent);
        
        endpoints[endpoint] = $('<h2>' + endpoint + '</h2><div class="endpoint"></div>');
        parent.append(endpoints[endpoint]);
      }
      
      var jj = 0;
      function addRunningData(endpoint, number) {
        var el = endpoints[endpoint];
        var klass = '';
        if (jj++ && jj % 10 === 0) {
          klass = 'alt';
        }
        
        el.append('<div class="' + klass + '" style="height:' + number + '%;" />');
        
        var divs   = el.find('div'),
            max    = el.width() / 6;
        
        if (divs.length > max) {
          var over = divs.length - max - 1;
          el.find('div:lt(' + over + ')').remove();
          divs = el.find('div');
        }
        
        divs.each(function (i, el) {
          el.style.right =  (divs.length * 6) - (i * 6) + 'px';
        });
      }
      
      // var i = 1000;
      // 
      // (function go() {
      //   addRunningData(~~(Math.random() * 100));
      //   
      //   if (i--) {
      //     setTimeout(go, 100);
      //   }
      // }());
      
      var socket = new WebSocket('ws://localhost:8000');
      socket.onmessage = function (msg) {
        var data = JSON.parse(msg.data);
        
        if (!endpoints[data.endpoint]) {
          createEndpoint('#running', data.endpoint);
        }
        
        addRunningData(data.endpoint, data.amount + 1);
      };
      
    </script>
  </body>
</html>